<div class="list-card">
  <p-confirmpopup key="deleteStudent"></p-confirmpopup>
  <h2>All Students</h2>
    <p-table #dt2 [value]="customGlobalFilterItems()" [paginator]="true" [rows]="10" [loading]="loading()"
     [globalFilterFields]="globalFilter" [reorderableColumns]="true" (onColReorder)="onColReorder($event)">
    
    <ng-template #caption>
      <div *ngIf="!isMobile()" class="flex gap-2">
          <p-iconfield iconPosition="left" class="ml-auto">
              <p-inputicon>
                  <i class="pi pi-search"></i>
              </p-inputicon>
              <input pInputText id="searchBox" (input)="customGlobalFilter($event.target.value)" placeholder="Search" autocomplete="off" />
          </p-iconfield>
          
          <!-- Column Toggle  -->
          <div class="">
            <p-multiSelect
              [options]="allColumns"
              [(ngModel)]="selectedColumns"
              optionLabel="header"
              display="chip"
              placeholder="Toggle Columns"
              [showToggleAll]="true"
            />
          </div>
          
      </div>
      <div *ngIf="isMobile()" class="flex justify-content-end">
        <button pButton icon="pi pi-sliders-h" label="Filters" (click)="toggleFilterMenu()"></button>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        @for (col of visibleColumns; track col.field) {
          @if (col.field === 'actions') {
            <th>{{ col.header }}</th>
          }@else {
            @if (col.sortable) {
            <th pSortableColumn="{{ col.field }}" pReorderableColumn>
                <div class="flex gap-2" >
                  {{ col.header }}
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </div>
            </th>
            } @else {
              <th pReorderableColumn>
                {{ col.header }}
              </th>
            }
          }
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-student>
      <tr>
        @for (col of visibleColumns; track col.field) {
          <td>
            @switch (col.field) {
              @case ('profilePic') {
                <img [src]="student?.user?.profilePic" alt="profile" class="w-7rem border-round max-h-5rem" />
              }
              @case ('dob') {
                {{student.dob | date}}
              }
              @case ('address') {
                <button pButton type="button" icon="pi pi-eye" label="View" (click)="viewAddress(student.address)"></button>
              }
              @case ('photos') {
                <button pButton type="button" icon="pi pi-images" label="View" (click)="viewPhotos(student.photos)"></button>
              }
              @case ('courses') {
                <button pButton type="button" icon="pi pi-book" label="View" (click)="viewCourses(student.courses)"></button>
              }
              @case ('actions') {
                <div class="action-icons">
                  @if (loggedUserRole === 'admin' || loggedUserRole === 'editor') {
                    <i class="pi pi-pencil edit-icon" title="Edit" (click)="navigate(student._id)"></i>
                  }
                  @if (loggedUserRole === 'admin') {
                    <i class="pi pi-trash delete-icon" title="Delete" (click)="deleteStudent(student._id, $event)"></i>
                  }
                </div>
              }@default {
                {{ resolveField(student, col.field) }}
              }
            }
          </td>
        }
      </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="5">No students found</td>
        </tr>
    </ng-template>
  </p-table>
</div>

<!-- Mobile Filter Drawer -->
  <p-drawer 
    [visible]="filterMenuVisible()" 
    position="right" 
    [modal]="true" 
    (onHide)="filterMenuVisible.set(false)">
    <ng-template pTemplate="header">
        <h3>Filters</h3>
    </ng-template>

    <div class="p-3 flex flex-column gap-3">
        <p-iconfield iconPosition="left">
            <p-inputicon>
                <i class="pi pi-search"></i>
            </p-inputicon>
            <input 
              pInputText 
              id="mobileSearchBox" 
              (input)="dt2.filterGlobal($event.target.value, 'contains')" 
              placeholder="Search Users"
              autocomplete="off" />
        </p-iconfield>

        <p-multiSelect
          [options]="allColumns"
          [(ngModel)]="selectedColumns"
          optionLabel="header"
          display="chip"
          placeholder="Toggle Columns"
          [showToggleAll]="true"
        />

        <button pButton label="Close" icon="pi pi-times" class="p-button-secondary" (click)="filterMenuVisible.set(false)"></button>
    </div>
  </p-drawer>

<!-- Address Modal -->
<p-dialog header="Student Address" [(visible)]="showAddressDialog" [modal]="true" [style]="{width: '400px'}" [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">
  @if(selectedAddress?.city != '' && selectedAddress?.city != null) {
    <p>{{ selectedAddress.street }}, {{ selectedAddress.city }}, {{ selectedAddress.state }} - {{ selectedAddress.zip }}</p>
  } @else {
    <p>No address available</p>
  }
</p-dialog>

<!-- Photos Modal -->
<p-dialog header="Student Documents" [(visible)]="showPhotosDialog" [modal]="true" [style]="{width: '600px'}" [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">
  <p-galleria *ngIf="selectedPhotos?.length" [value]="selectedPhotos" [showItemNavigators]="true" [showThumbnails]="true" [circular]="true">
    <ng-template pTemplate="item" let-photo>
      <img [src]="photo" class="w-full border-round" />
    </ng-template>
    <ng-template pTemplate="thumbnail" let-photo>
      <img [src]="photo" class="w-5rem border-round" />
    </ng-template>
  </p-galleria>
  <p *ngIf="!selectedPhotos?.length">No documents uploaded</p>
</p-dialog>

<!-- Courses Modal with Accordion -->
<p-dialog header="Student Courses" [(visible)]="showCoursesDialog" [modal]="true" [style]="{width: '600px'}" [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">
    <p-accordion [value]="['0']" [multiple]="true" *ngIf="selectedCourses?.length">
        <p-accordion-panel *ngFor="let course of selectedCourses; let i = index" [value]="i.toString()">
            <p-accordion-header>
                {{ course.course }}
            </p-accordion-header>
            <p-accordion-content>
                <p><b>Name:</b> {{ course.course }}</p>
                <p><b>Batch Year:</b> {{ course.batchYear }}</p>
                <p><b>Status:</b> {{ course.status }}</p>
            </p-accordion-content>
        </p-accordion-panel>
    </p-accordion>

    <p *ngIf="!selectedCourses?.length">No courses enrolled</p>

</p-dialog>
